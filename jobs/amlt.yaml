# Documentation:
# https://amulet-docs.azurewebsites.net/main/advanced/51_distributed.html#
# https://amulet-docs.azurewebsites.net/config_file.html

description: ML Template Experiment - MNIST

# commondockerimages.azurecr.io:
# https://ms.portal.azure.com/#@microsoft.onmicrosoft.com/resource/subscriptions/964a24a8-8835-43c1-9633-7d78841facf1/resourceGroups/research_team/providers/Microsoft.ContainerRegistry/registries/commondockerimages/repository
environment:
  registry: commondockerimages.azurecr.io
  username: commondockerimages
  image: ml_template:latest # same as latest-azureml # see docker/Dockerfile_base_azureml
  # image: ml_template:latest-azureml-nightly # see docker/Dockerfile_base_azureml_nightly
  # image: ml_template:latest-nvidia # see docker/Dockerfile_base_nvidia
  # image: ml_template:PR-51-latest # test a PR's CI build before merging your code to main
  setup:
    - pip install -e .

# $CONFIG_DIR is expanded to the directory of this config file.
code:
  local_dir: $CONFIG_DIR/../

data:
  local_dir: $CONFIG_DIR/../data
  remote_dir: lightning_template/data

# SKU usage: G1 (single GPU), G4 (quad GPU), G4-V100 (1 machine, 4 V100 gpus), etc...
jobs:
  # amlt run jobs/amlt.yaml --target-name V100-1x-ded :train_1_node_1_gpu ml-template-mnist
  - name: train_1_node_1_gpu
    sku: 1xG1
    submit_args:
      container_args:
        shm_size: 650g
      env: { AZUREML_COMPUTE_USE_COMMON_RUNTIME: True }
    command:
      - export MKL_THREADING_LAYER="GNU"
      - python src/system_monitor.py --watch_every_n_seconds 5 &
      - python src/train.py -c configs/train.yaml --trainer.gpus=1 --trainer.max_epochs=50

  # amlt run jobs/amlt.yaml --target-name V100-4x-ded :train_1_node_4_gpus ml-template-mnist
  - name: train_1_node_4_gpus
    sku: 1xG4
    process_count_per_node: 4
    submit_args:
      container_args:
        shm_size: 650g
      env: { AZUREML_COMPUTE_USE_COMMON_RUNTIME: True }
    command:
      - export MKL_THREADING_LAYER="GNU"
      - python src/system_monitor.py --watch_every_n_seconds 5 &
      - python src/train.py -c configs/train.yaml --trainer.gpus=4 --trainer.max_epochs=50

  # amlt run jobs/amlt.yaml --target-name V100-4x-ded :train_distributed_2_nodes_4_gpus ml-template-mnist
  - name: train_distributed_2_nodes_4_gpus
    sku: 2xG4
    process_count_per_node: 4
    submit_args:
      container_args:
        shm_size: 650g
      env: { AZUREML_COMPUTE_USE_COMMON_RUNTIME: True }
    command:
      - export MKL_THREADING_LAYER="GNU"
      - python src/system_monitor.py --watch_every_n_seconds 5 &
      - python src/train.py -c configs/train.yaml --trainer.num_nodes=2 --trainer.gpus=4 --trainer.max_epochs=50
